{extend name="default/base" /}
{block name="extendcss"}
<style>
    .layui-upload-file{
        display: none !important;
    }
</style>
{/block}
{block name="content"}
<div class="container content">
    {if sizeof($orders) > 0}
    {foreach $orders as $k}
    <div class="row order-list">
        <div class="col-sm-9">

            <span>订单号：{$k.order_no}</span>
            {if sizeof($k.order_goods) > 0}
            {foreach $k.order_goods as $v}
            <div class="row order-good">
                <div class="col-md-3 col-sm-3 col-xs-5">
                    <img class="thumbnail" src="{$v.good.img_url|default='/static/img/null.png'}" alt="{$v.good.title}" width="120px">
                </div>
                <div class="col-md-6 col-sm-6 col-xs-6">
                    <h4>{$v.good.title}</h4>
                    {if $v.good.is_prescription == 1}<p class="red">处方药</p>{/if}
                </div>
                <div class="col-md-3 col-sm-3 col-xs-6">
                    <h4>￥ {:sprintf('%.2f',$v.price * $v.num)}</h4>
                    <p>数量：{$v.num}</p>
                    {if $v.good.is_prescription == 1 && $k.status != 0 && (empty($v.prescription) || $v.prescription == 'false')}
                    <a class="btn btn-sm btn-warning upload-btn" lay-data="{data:{id:{$v.id}}}"><i class="
glyphicon glyphicon-picture"></i> 上传处方</a>
                    {elseif $v.prescription == 'true'}
                    <a class="btn btn-sm btn-success"><i class="
glyphicon glyphicon-ok"></i> 审核通过</a>
                    {elseif !empty($v.prescription)}
                    <a class="btn btn-sm btn-info"><i class="
glyphicon glyphicon-flag"></i> 审核中</a>
                    {/if}
                </div>
            </div>
            {/foreach}
            {/if}
        </div>
        <div class="col-sm-2 col-xs-8">
            状态：
            {if $k.status == 0}
            订单关闭
            {elseif $k.status == 1}
            支付成功
            {elseif $k.status == 2}
            未支付
            {elseif $k.status == 3 || ($k.status == 4 && !empty($k.track_no))}
            运送中
            <p>单号：<a target="_blank" href="https://www.kuaidi100.com/chaxun?nu={$k.track_no}">{$k.track_no}</a></p>
            {elseif ($k.status == 4 && empty($k.track_no))}
            待发货（货到付款）
            {elseif $k.status == 5}
            待评价
            {elseif $k.status == 6}
            订单完成
            {else}
            订单异常
            {/if}
            <h4 class="text-danger">小计 ￥{:sprintf('%.2f',$k.total_price)}</h4>
        </div>
        <div class="col-sm-1 col-xs-4">
            {if $k.status == 1}
            <p><a class="btn btn-sm btn-danger" href="{:url('index/user/cancel', ['id' => $k.order_no])}"><i class="glyphicon glyphicon-ban-circle"></i> 取消订单</a></p>
            {elseif $k.status == 2}
            <p><a class="btn btn-sm btn-success" href="{:url('index/user/pay', ['id' => $k.order_no])}"><i class="
glyphicon glyphicon-yen"></i> 支付</a></p>
            <p><a class="btn btn-sm btn-info" href="{:url('index/user/afterPay', ['id' => $k.order_no])}"><i class="glyphicon glyphicon-send"></i> 货到付款</a></p>
            <p><a class="btn btn-sm btn-danger" href="{:url('index/user/cancel', ['id' => $k.order_no])}"><i class="glyphicon glyphicon-ban-circle"></i> 取消订单</a></p>
            {elseif $k.status == 3 || ($k.status == 4 && !empty($k.track_no))}
            <p><a class="btn btn-sm btn-success" href="{:url('index/user/shipped', ['id' => $k.order_no])}"><i class="glyphicon glyphicon-ok-circle"></i> 收货</a></p>
            {elseif $k.status == 5}
            <p><a class="btn btn-sm btn-info" href="{:url('index/user/rate', ['order' => $k.order_no])}"><i class="glyphicon glyphicon-star"></i> 评价</a></p>
            {elseif $k.status == 4}
            <p><a class="btn btn-sm btn-danger" href="{:url('index/user/cancel', ['id' => $k.order_no])}"><i class="glyphicon glyphicon-ban-circle"></i> 取消订单</a></p>
            {/if}
        </div>
        <br>
    </div>
    <hr>
    {/foreach}
    <br>
    {$orders->render()|raw}
    {else}
    <h3>暂无订单</h3>
    {/if}
</div>
{/block}
{block name="extendjs"}
<script src="/static/layuiadmin/layui/layui.js"></script>
<script>
    layui.config({
        base: '/static/layuiadmin/' //静态资源所在路径
    }).extend({
        index: 'lib/index' //主入口模块
    }).use('upload', function(){
        var upload = layui.upload;

        upload.render({
            elem: '.upload-btn'
            ,url: '{:url("index/user/uploadPrescription")}'
            ,accept: 'images'
            ,field: 'upload'
            ,done: function(res, index, upload){
                layer.msg(res.msg, {icon: res.code == 1 ? 1: 2,time: 1500});

                setInterval(function () {
                    location.reload();
                }, 3000);
            }
        })
    });

</script>
{/block}